<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>18.5. Creating a Many-to-Many Relationship &#8212; C# Web Development  documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/fa/css/all.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/launchcode.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/site.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="18.6. Exercises: The Early Bird Gets the ORM." href="exercises.html" />
    <link rel="prev" title="18.4. Some Setup" href="some-setup.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body class="body-bc">

<div id="navbar" class="navbar navbar-default navbar-fixed-top">
   <div class="container">
     <div class="navbar-header">
       <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
       <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
       </button>
       <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/lc-ed-logo.png" alt="LaunchCode logo"></span>
       </a>
       <span class="navbar-text navbar-version pull-left"><b></b></span>
     </div>

       <div class="collapse navbar-collapse nav-collapse">
         <ul class="nav navbar-nav">
           
           
             
           
           
           
           
           
         </ul>

         
           
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
    <label for="q" class="searchLabel">Search</label>
    <input type="text" name="q" class="form-control" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
         
       </div>
   </div>
 </div>

<ol class="breadcrumb container">
    <li><a href="../../index.html">Contents</a></li>
    <li><a href="index.html"><span class="section-number">18. </span>Relationships in Object-Relational Mapping</a></li>
    <li class="active"><span class="section-number">18.5. </span>Creating a Many-to-Many Relationship</li>
</ol>



<div class="container">
  <div class="row">
    <div class="col-md-10 col-md-offset-1 content " role="main">

    
  <div class="section" id="creating-a-many-to-many-relationship">
<h1><span class="section-number">18.5. </span>Creating a Many-to-Many Relationship<a class="headerlink" href="#creating-a-many-to-many-relationship" title="Permalink to this headline">¶</a></h1>
<p>Let’s set up a many-to-many relationship between <code class="docutils literal notranslate"><span class="pre">Event</span></code> and <code class="docutils literal notranslate"><span class="pre">Tag</span></code>.</p>
<div class="section" id="join-tables">
<h2><span class="section-number">18.5.1. </span>Join Tables<a class="headerlink" href="#join-tables" title="Permalink to this headline">¶</a></h2>
<p>To relate data in a many-to-many fashion in a relational database requires a new type of SQL table.</p>
<p>One-to-many relationships are established at the database level by the use of a foreign key column on one side of the relationship. Our <code class="docutils literal notranslate"><span class="pre">Events</span></code> table has a foreign key column: <code class="docutils literal notranslate"><span class="pre">CategoryId</span></code>.</p>
<p>For each <code class="docutils literal notranslate"><span class="pre">Events</span></code> row, the column <code class="docutils literal notranslate"><span class="pre">CategoryId</span></code> contains the <code class="docutils literal notranslate"><span class="pre">Id</span></code> of a <code class="docutils literal notranslate"><span class="pre">Categories</span></code> row. This is the primary key of the row in <code class="docutils literal notranslate"><span class="pre">Categories</span></code> that the <code class="docutils literal notranslate"><span class="pre">Events</span></code> row is related to. The <code class="docutils literal notranslate"><span class="pre">Event</span></code>/<code class="docutils literal notranslate"><span class="pre">EventCategory</span></code> relationship is many-to-one, so <em>many</em> event rows may have the same <code class="docutils literal notranslate"><span class="pre">CategoryId</span></code> value.</p>
<p id="index-0">Using foreign and primary keys to create many-to-many relationships is a bit trickier. In order to relate rows in <code class="docutils literal notranslate"><span class="pre">Events</span></code> to rows in <code class="docutils literal notranslate"><span class="pre">Tag</span></code>, we need need a third table, known as a <strong>join table</strong>. A join table consists of two columns, each of which is a foreign key column to another table. Each row in a join table represents a relationship between one row in each of the two tables being joined. This technique enables many-to-many relationships.</p>
<p>Consider some example data in our <code class="docutils literal notranslate"><span class="pre">Events</span></code> and <code class="docutils literal notranslate"><span class="pre">Tags</span></code> tables.</p>
<table class="docutils align-default" id="id5">
<caption><span class="caption-text">Sample <code class="docutils literal notranslate"><span class="pre">Events</span></code> data</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Id</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>CategoryId</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>13</p></td>
<td><p>WWDC</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>15</p></td>
<td><p>SpringOne Platform</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>17</p></td>
<td><p>Java meetup</p></td>
<td><p>3</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id6">
<caption><span class="caption-text">Sample <code class="docutils literal notranslate"><span class="pre">Categories</span></code> data</span><a class="headerlink" href="#id6" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Id</p></th>
<th class="head"><p>Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2</p></td>
<td><p>Conference</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>Meetup</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id7">
<caption><span class="caption-text">Sample <code class="docutils literal notranslate"><span class="pre">Tags</span></code> data</span><a class="headerlink" href="#id7" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Id</p></th>
<th class="head"><p>Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>4</p></td>
<td><p>ios</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>spring</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>java</p></td>
</tr>
</tbody>
</table>
<p>A join table for these two tables would be called <code class="docutils literal notranslate"><span class="pre">EventTags</span></code>, and would have two columns, <code class="docutils literal notranslate"><span class="pre">EventId</span></code> and <code class="docutils literal notranslate"><span class="pre">TagId</span></code>. Each of these columns are foreign key columns into their respective tables.</p>
<p>If we want to relate the <code class="docutils literal notranslate"><span class="pre">ios</span></code> tag to the <code class="docutils literal notranslate"><span class="pre">WWDC</span></code> event, we create a new row in <code class="docutils literal notranslate"><span class="pre">EventTags</span></code>:</p>
<table class="docutils align-default" id="id8">
<caption><span class="caption-text">A join table with a single relationship</span><a class="headerlink" href="#id8" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>EventId</p></th>
<th class="head"><p>TagId</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>13</p></td>
<td><p>4</p></td>
</tr>
</tbody>
</table>
<p>We can do this again and again to generate more relationships. Let’s revisit the many-to-many diagram from earlier in the chapter.</p>
<div class="figure align-default" id="id9">
<a class="reference internal image-reference" href="../../_images/many-to-many.png"><img alt="Three Event objects on the left, with various relationships to three Tag objects on the right" src="../../_images/many-to-many.png" style="width: 800px;" /></a>
<p class="caption"><span class="caption-text">A many-to-many relationship between Event and Tag objects</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
<p>The join table representing these relationships looks like this:</p>
<table class="docutils align-default" id="id10">
<caption><span class="caption-text">The full join table representing the relationships in the figure above</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>EventId</p></th>
<th class="head"><p>TagId</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>13</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-odd"><td><p>15</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>15</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-odd"><td><p>17</p></td>
<td><p>6</p></td>
</tr>
</tbody>
</table>
<p id="index-1">Notice that join table doesn’t have an explicit primary key column. Values in both <code class="docutils literal notranslate"><span class="pre">EventId</span></code> and <code class="docutils literal notranslate"><span class="pre">TagId</span></code> may be duplicated in each column. Indeed, this is the exact property of a join table that allows many-to-many relationships. A join table makes use of a new type of primary key, called a <strong>composite primary key</strong>. A composite primary key is a combination of columns that is unique and functions as a primary key. So, for example, the primary key of the first row of the example just above is the pair (13, 4). This combination is unique, because the objects with the two IDs can be related to each other in only one way.</p>
<p>In order to enable many-to-many relationships with EF, we need a class to model a join table.</p>
</div>
<div class="section" id="the-eventtag-model-video">
<h2><span class="section-number">18.5.2. </span>The <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> Model - Video<a class="headerlink" href="#the-eventtag-model-video" title="Permalink to this headline">¶</a></h2>
<p>Let’s create a new model class, <code class="docutils literal notranslate"><span class="pre">EventTag</span></code>, to model a join table for <code class="docutils literal notranslate"><span class="pre">Event</span></code> and <code class="docutils literal notranslate"><span class="pre">Tag</span></code> classes.</p>
<div class="admonition-note admonition">
<p class="admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>The starter code for this video is found at the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/event-detail-view" target="_blank">event-detail-view branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> of <code class="docutils literal notranslate"><span class="pre">CodingEventsDemo</span></code>. The final code presented in this video is found on the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/event-tag-model" target="_blank">event-tag-model branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a>. As always, code along to the videos on your own <code class="docutils literal notranslate"><span class="pre">CodingEvents</span></code> project.</p>
</div>

<div style="text-align:center;"><iframe width="800" height="450" src="https://www.youtube.com/embed/xZLFVV9SHiM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p></p>
</div>
<div class="section" id="the-eventtag-model-text">
<h2><span class="section-number">18.5.3. </span>The <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> Model - Text<a class="headerlink" href="#the-eventtag-model-text" title="Permalink to this headline">¶</a></h2>
<p id="index-2">To model a join table for <code class="docutils literal notranslate"><span class="pre">Event</span></code> and <code class="docutils literal notranslate"><span class="pre">Tag</span></code> classes, we will create a <strong>join class</strong>. Given our discussion of join tables above, we know that it will need <code class="docutils literal notranslate"><span class="pre">EventId</span></code> and <code class="docutils literal notranslate"><span class="pre">TagId</span></code> properties. To more easily work with the corresponding <code class="docutils literal notranslate"><span class="pre">Event</span></code> and <code class="docutils literal notranslate"><span class="pre">Tag</span></code> objects in our controllers, we will also include properties of those specific types.</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">namespace</span> <span class="nn">CodingEventsDemo.Models</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="k">class</span> <span class="nc">EventTag</span>
   <span class="p">{</span>

      <span class="k">public</span> <span class="kt">int</span> <span class="n">EventId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">public</span> <span class="n">Event</span> <span class="n">Event</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

      <span class="k">public</span> <span class="kt">int</span> <span class="n">TagId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">public</span> <span class="n">Tag</span> <span class="n">Tag</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

      <span class="k">public</span> <span class="nf">EventTag</span><span class="p">()</span>
      <span class="p">{</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>To make this class persistent, and a new <code class="docutils literal notranslate"><span class="pre">DbSet</span></code> entry to <code class="docutils literal notranslate"><span class="pre">EventDbContext</span></code>:</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">EventTag</span><span class="p">&gt;</span> <span class="n">EventTags</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p id="index-3">Since our join table will make use of a composite primary key, we need to add some additional configuration to <code class="docutils literal notranslate"><span class="pre">EventDbContext</span></code>.</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">EventTag</span><span class="p">&gt;()</span>
         <span class="p">.</span><span class="n">HasKey</span><span class="p">(</span><span class="n">et</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="p">{</span> <span class="n">et</span><span class="p">.</span><span class="n">EventId</span><span class="p">,</span> <span class="n">et</span><span class="p">.</span><span class="n">TagId</span> <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The method <code class="docutils literal notranslate"><span class="pre">OnModelCreating</span></code> can be overridden from the base class, <code class="docutils literal notranslate"><span class="pre">DbContext</span></code>, in order to provide additional configuration for the data store. In this case, we add code that configures <code class="docutils literal notranslate"><span class="pre">EntityTag</span></code> to have a composite primary key consisting of the properties/columns <code class="docutils literal notranslate"><span class="pre">EventId</span></code> and <code class="docutils literal notranslate"><span class="pre">TagId</span></code>.</p>
<p>This completes configuration of our join class. Before proceeding, create and apply a database migration. Refer to the <a class="reference internal" href="one-to-many.html#create-migration"><span class="std std-ref">previous section</span></a> for details if needed, being sure to use a unique, descriptive migration name. After running the migration, verify that there is a new join table, <code class="docutils literal notranslate"><span class="pre">EventTag</span></code>.</p>
</div>
<div class="section" id="adding-a-tag-to-an-event-video">
<h2><span class="section-number">18.5.4. </span>Adding a <code class="docutils literal notranslate"><span class="pre">Tag</span></code> to an <code class="docutils literal notranslate"><span class="pre">Event</span></code> - Video<a class="headerlink" href="#adding-a-tag-to-an-event-video" title="Permalink to this headline">¶</a></h2>
<p>Now that we have established a many-to-many relationship between <code class="docutils literal notranslate"><span class="pre">Event</span></code> and <code class="docutils literal notranslate"><span class="pre">Tag</span></code>, we can write controller and view code to allow users to add tags to events.</p>
<div class="admonition-note admonition">
<p class="admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>The starter code for this video is found at the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/event-tag-model" target="_blank">event-tag-model branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> of <code class="docutils literal notranslate"><span class="pre">CodingEventsDemo</span></code>. The final code presented in this video is found on the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/add-tag-to-event" target="_blank">add-tag-to-event branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a>. As always, code along to the videos on your own <code class="docutils literal notranslate"><span class="pre">CodingEvents</span></code> project.</p>
</div>

<div style="text-align:center;"><iframe width="800" height="450" src="https://www.youtube.com/embed/KwAqPy2nDsU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p></p>
</div>
<div class="section" id="adding-a-tag-to-an-event-text">
<h2><span class="section-number">18.5.5. </span>Adding a <code class="docutils literal notranslate"><span class="pre">Tag</span></code> to an <code class="docutils literal notranslate"><span class="pre">Event</span></code> - Text<a class="headerlink" href="#adding-a-tag-to-an-event-text" title="Permalink to this headline">¶</a></h2>
<p>For a user to be able to add a tag to an event, they will need a view in which to do so. Our approach will be to create a view at the path <code class="docutils literal notranslate"><span class="pre">/Tag/AddEvent/X</span></code>, where <code class="docutils literal notranslate"><span class="pre">X</span></code> is a path parameter containing the ID of the event we want to add a tag to.</p>
<p>This new view will contain a form with a dropdown that will allow the user to select the tag to add to the event with ID <code class="docutils literal notranslate"><span class="pre">X</span></code>. To model this form data, we need a new ViewModel.</p>
<div class="section" id="viewmodels-addeventtagviewmodel">
<h3><span class="section-number">18.5.5.1. </span><code class="docutils literal notranslate"><span class="pre">ViewModels/AddEventTagViewModel</span></code><a class="headerlink" href="#viewmodels-addeventtagviewmodel" title="Permalink to this headline">¶</a></h3>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CodingEventsDemo.Models</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc.Rendering</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CodingEventsDemo.ViewModels</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="k">class</span> <span class="nc">AddEventTagViewModel</span>
   <span class="p">{</span>
<span class="na">      [Required(ErrorMessage = &quot;Event is required&quot;)]</span>
      <span class="k">public</span> <span class="kt">int</span> <span class="n">EventId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="na">      [Required(ErrorMessage = &quot;Tag is required&quot;)]</span>
      <span class="k">public</span> <span class="kt">int</span> <span class="n">TagId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

      <span class="k">public</span> <span class="n">Event</span> <span class="n">Event</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

      <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SelectListItem</span><span class="p">&gt;</span> <span class="n">Tags</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

      <span class="k">public</span> <span class="nf">AddEventTagViewModel</span><span class="p">(</span><span class="n">Event</span> <span class="n">theEvent</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tag</span><span class="p">&gt;</span> <span class="n">possibleTags</span><span class="p">)</span>
      <span class="p">{</span>
            <span class="n">Tags</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SelectListItem</span><span class="p">&gt;();</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">tag</span> <span class="k">in</span> <span class="n">possibleTags</span><span class="p">)</span>
            <span class="p">{</span>
               <span class="n">Tags</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">SelectListItem</span>
               <span class="p">{</span>
                  <span class="n">Value</span> <span class="p">=</span> <span class="n">tag</span><span class="p">.</span><span class="n">Id</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span>
                  <span class="n">Text</span> <span class="p">=</span> <span class="n">tag</span><span class="p">.</span><span class="n">Name</span>
               <span class="p">});</span>
            <span class="p">}</span>

            <span class="n">Event</span> <span class="p">=</span> <span class="n">theEvent</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">public</span> <span class="nf">AddEventTagViewModel</span><span class="p">()</span>
      <span class="p">{</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This class models the data that is need to render and process our form. In order to add a tag to an event, our <code class="docutils literal notranslate"><span class="pre">POST</span></code> handler will need to know the IDs of the two objects in question. Therefore, our ViewModel has required <code class="docutils literal notranslate"><span class="pre">EventId</span></code> and <code class="docutils literal notranslate"><span class="pre">TagId</span></code> properties. It also contains an <code class="docutils literal notranslate"><span class="pre">Event</span></code> property, which we will use to display details (such as the event name) in the view.</p>
<p>Finally, the ViewModel has a property <code class="docutils literal notranslate"><span class="pre">List&lt;SelectListItem&gt;</span> <span class="pre">Tags</span></code>. As with previous forms containing a dropdown, this property will be used to populate the <code class="docutils literal notranslate"><span class="pre">select</span></code> element containing the all of the tag options.</p>
<p>The constructor requires an <code class="docutils literal notranslate"><span class="pre">Event</span></code> object as well as a <code class="docutils literal notranslate"><span class="pre">List&lt;Tag&gt;</span></code> object. The list will contain a collection of all tags pulled from the database when we call the constructor from within our controller.</p>
<p>Now, let’s create the view template.</p>
</div>
<div class="section" id="views-tag-addevent-cshtml">
<h3><span class="section-number">18.5.5.2. </span><code class="docutils literal notranslate"><span class="pre">Views/Tag/AddEvent.cshtml</span></code><a class="headerlink" href="#views-tag-addevent-cshtml" title="Permalink to this headline">¶</a></h3>
<p>Our template needs a form with two inputs. The more obvious input will be the <code class="docutils literal notranslate"><span class="pre">select</span></code> element containing tag options. Since we also need to submit the event ID in our request, we’ll add a hidden input that holds the value of <code class="docutils literal notranslate"><span class="pre">EventId</span></code> from our ViewModel.</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span>@model CodingEventsDemo.ViewModels.AddEventTagViewModel

<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Add Tag to Event: @Model.Event.Name<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">asp-controller</span><span class="o">=</span><span class="s">&quot;Tag&quot;</span> <span class="na">asp-action</span><span class="o">=</span><span class="s">&quot;AddEvent&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;@Model.Event.Id&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;EventId&quot;</span> <span class="p">/&gt;</span>
   <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span> <span class="na">asp-for</span><span class="o">=</span><span class="s">&quot;TagId&quot;</span><span class="p">&gt;</span>Tag<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">select</span> <span class="na">asp-for</span><span class="o">=</span><span class="s">&quot;TagId&quot;</span> <span class="na">asp-items</span><span class="o">=</span><span class="s">&quot;Model.Tags&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">asp-validation-for</span><span class="o">=</span><span class="s">&quot;TagId&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Add Tag&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="get-and-post-handlers">
<h3><span class="section-number">18.5.5.3. </span><code class="docutils literal notranslate"><span class="pre">GET</span></code> and <code class="docutils literal notranslate"><span class="pre">POST</span></code> Handlers<a class="headerlink" href="#get-and-post-handlers" title="Permalink to this headline">¶</a></h3>
<p>We’re now ready to add handler methods to <code class="docutils literal notranslate"><span class="pre">TagController</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">GET</span></code> method is simple since it just displays the form.</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>50
51
52
53
54
55
56
57</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// responds to URLs like /Tag/AddEvent/5 (where 5 is an event ID)</span>
<span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">AddEvent</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">Event</span> <span class="n">theEvent</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
   <span class="n">List</span><span class="p">&lt;</span><span class="n">Tag</span><span class="p">&gt;</span> <span class="n">possibleTags</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Tags</span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
   <span class="n">AddEventTagViewModel</span> <span class="n">viewModel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AddEventTagViewModel</span><span class="p">(</span><span class="n">theEvent</span><span class="p">,</span> <span class="n">possibleTags</span><span class="p">);</span>
   <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">viewModel</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This method creates an <code class="docutils literal notranslate"><span class="pre">AddEventTagViewModel</span></code> using the event specified by the <code class="docutils literal notranslate"><span class="pre">id</span></code> parameter and the list of all tags from the database. Then it renders the view.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">POST</span></code> method is more complicated.</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="na">[HttpPost]</span>
<span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">AddEvent</span><span class="p">(</span><span class="n">AddEventTagViewModel</span> <span class="n">viewModel</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
   <span class="p">{</span>

      <span class="kt">int</span> <span class="n">eventId</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">EventId</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">tagId</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">TagId</span><span class="p">;</span>

      <span class="n">EventTag</span> <span class="n">eventTag</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EventTag</span> <span class="p">{</span>
         <span class="n">EventId</span> <span class="p">=</span> <span class="n">eventId</span><span class="p">,</span>
         <span class="n">TagId</span> <span class="p">=</span> <span class="n">tagId</span>
      <span class="p">};</span>
      <span class="n">context</span><span class="p">.</span><span class="n">EventTags</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">eventTag</span><span class="p">);</span>
      <span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>

      <span class="k">return</span> <span class="nf">Redirect</span><span class="p">(</span><span class="s">&quot;/Events/Detail/&quot;</span> <span class="p">+</span> <span class="n">eventId</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">viewModel</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This action method takes in a <code class="docutils literal notranslate"><span class="pre">AddEventTagViewModel</span></code> object which will be created via model binding. Assuming validation passes (that is, both <code class="docutils literal notranslate"><span class="pre">EventId</span></code> and <code class="docutils literal notranslate"><span class="pre">TagId</span></code> are not <code class="docutils literal notranslate"><span class="pre">null</span></code>) we create a new <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> object and save it to the database. Then we redirect to the detail view for the given event.</p>
<p>With this code, we can now add a tag to an event. Start up the application and test it out. In order to verify that everything worked, you’ll need to look at the <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> table in the database to verify a new row is created upon form submission.</p>
<p>In the next section, we’ll work to display tags in the view.</p>
</div>
</div>
<div class="section" id="displaying-tags-in-the-detail-view-video">
<h2><span class="section-number">18.5.6. </span>Displaying Tags in the Detail View - Video<a class="headerlink" href="#displaying-tags-in-the-detail-view-video" title="Permalink to this headline">¶</a></h2>
<p>Now that we have <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> data in the database, let’s display the tags for a given event in the view.</p>
<div class="admonition-note admonition">
<p class="admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>The starter code for this video is found at the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/add-tag-to-event" target="_blank">add-tag-to-event branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> of <code class="docutils literal notranslate"><span class="pre">CodingEventsDemo</span></code>. The final code presented in this video is found on the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/display-tags" target="_blank">display-tags branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a>. As always, code along to the videos on your own <code class="docutils literal notranslate"><span class="pre">CodingEvents</span></code> project</p>
</div>

<div style="text-align:center;"><iframe width="800" height="450" src="https://www.youtube.com/embed/WqhXqnXqnyk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p></p>
</div>
<div class="section" id="displaying-tags-in-the-detail-view-text">
<h2><span class="section-number">18.5.7. </span>Displaying Tags in the Detail View - Text<a class="headerlink" href="#displaying-tags-in-the-detail-view-text" title="Permalink to this headline">¶</a></h2>
<p>We want an event’s tags to be displayed on its detail view, so let’s start in <code class="docutils literal notranslate"><span class="pre">EventsController</span></code>. The <code class="docutils literal notranslate"><span class="pre">Detail</span></code> method needs to pass in tag data for the given event. To do this, we must query <code class="docutils literal notranslate"><span class="pre">context.EventTags</span></code> and pass the resulting list of <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> objects into the ViewModel’s constructor.</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>92
93
94
95
96
97</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">List</span><span class="p">&lt;</span><span class="n">EventTag</span><span class="p">&gt;</span> <span class="n">eventTags</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">EventTags</span>
      <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">et</span> <span class="p">=&gt;</span> <span class="n">et</span><span class="p">.</span><span class="n">EventId</span> <span class="p">==</span> <span class="n">id</span><span class="p">)</span>
      <span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">et</span> <span class="p">=&gt;</span> <span class="n">et</span><span class="p">.</span><span class="n">Tag</span><span class="p">)</span>
      <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>

<span class="n">EventDetailViewModel</span> <span class="n">viewModel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EventDetailViewModel</span><span class="p">(</span><span class="n">theEvent</span><span class="p">,</span> <span class="n">eventTags</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>Our query of <code class="docutils literal notranslate"><span class="pre">context.EventTags</span></code> has a few pieces:</p>
<ol class="arabic simple">
<li><p><strong>Line 93</strong> - Filters the <code class="docutils literal notranslate"><span class="pre">EventTags</span></code> set to include only objects related to the given <code class="docutils literal notranslate"><span class="pre">Event</span></code>.</p></li>
<li><p><strong>Line 94</strong> - Forces eager loading of the <code class="docutils literal notranslate"><span class="pre">Tag</span></code> property of those <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> objects.</p></li>
<li><p><strong>Line 95</strong> - Converts the <code class="docutils literal notranslate"><span class="pre">DbSet</span></code> to a list.</p></li>
</ol>
<div class="admonition-note admonition">
<p class="admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>You might be wondering why we have to query <code class="docutils literal notranslate"><span class="pre">context.EventTags</span></code>. Indeed, it would be convenient of we could just reference a <code class="docutils literal notranslate"><span class="pre">Tags</span></code> property from the <code class="docutils literal notranslate"><span class="pre">Event</span></code> class. But notice that there <em>is no such property</em> in <code class="docutils literal notranslate"><span class="pre">Event</span></code>. The many-to-many relationship is defined by the data in <code class="docutils literal notranslate"><span class="pre">EventTag</span></code>, so we must use this class in order to access related objects.</p>
</div>
<p>Now let’s move into <code class="docutils literal notranslate"><span class="pre">EventDetailsViewModel</span></code>. Here, we add data related to an event’s tags to pass into the view.</p>
<p>First, add a new string property named <code class="docutils literal notranslate"><span class="pre">TagText</span></code>.</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="kt">string</span> <span class="n">TagText</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Then in the constructor, add a parameter to represent the list of all of <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> objects associated with a given <code class="docutils literal notranslate"><span class="pre">Event</span></code>. Use this parameter to set the value of <code class="docutils literal notranslate"><span class="pre">TagText</span></code>.</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="nf">EventDetailViewModel</span><span class="p">(</span><span class="n">Event</span> <span class="n">theEvent</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">EventTag</span><span class="p">&gt;</span> <span class="n">eventTags</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">EventId</span> <span class="p">=</span> <span class="n">theEvent</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
   <span class="n">Name</span> <span class="p">=</span> <span class="n">theEvent</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
   <span class="n">Description</span> <span class="p">=</span> <span class="n">theEvent</span><span class="p">.</span><span class="n">Description</span><span class="p">;</span>
   <span class="n">ContactEmail</span> <span class="p">=</span> <span class="n">theEvent</span><span class="p">.</span><span class="n">ContactEmail</span><span class="p">;</span>
   <span class="n">CategoryName</span> <span class="p">=</span> <span class="n">theEvent</span><span class="p">.</span><span class="n">Category</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>

   <span class="n">TagText</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">eventTags</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
   <span class="p">{</span>
         <span class="n">TagText</span> <span class="p">+=</span> <span class="p">(</span><span class="s">&quot;#&quot;</span> <span class="p">+</span> <span class="n">eventTags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Tag</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="n">eventTags</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>
         <span class="p">{</span>
            <span class="n">TagText</span> <span class="p">+=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
         <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>We build up the contents of <code class="docutils literal notranslate"><span class="pre">TagText</span></code> by looping over <code class="docutils literal notranslate"><span class="pre">eventTags</span></code> and appending tag names, separated by commas. For example, if an event has tags with names <code class="docutils literal notranslate"><span class="pre">&quot;java&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;csharp&quot;</span></code>, and <code class="docutils literal notranslate"><span class="pre">&quot;object-oriented&quot;</span></code>, then the <code class="docutils literal notranslate"><span class="pre">TagList</span></code> will be <code class="docutils literal notranslate"><span class="pre">&quot;#java,</span> <span class="pre">#csharp,</span> <span class="pre">#object-oriented&quot;</span></code>.</p>
<p>Displaying this data in the view is straightforward. In <code class="docutils literal notranslate"><span class="pre">Views/Events/Detail.cshtml</span></code>, add an additional row to the table.</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Tags<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>@Model.TagText<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Now, any tags associated with the given event will display nicely.</p>
<p>To make it easy for users to add a tag to an event, add the following link below the table.</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">asp-controller</span><span class="o">=</span><span class="s">&quot;Tag&quot;</span> <span class="na">asp-action</span><span class="o">=</span><span class="s">&quot;AddEvent&quot;</span> <span class="na">asp-route-id</span><span class="o">=</span><span class="s">&quot;@Model.EventId&quot;</span><span class="p">&gt;</span>Add Tag<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>This creates a URL of the form <code class="docutils literal notranslate"><span class="pre">/Tag/AddEvent/X</span></code>, where <code class="docutils literal notranslate"><span class="pre">X</span></code> is the ID of the given event.</p>
</div>
<div class="section" id="preventing-errors-when-adding-a-tag-video">
<h2><span class="section-number">18.5.8. </span>Preventing Errors When Adding a Tag - Video<a class="headerlink" href="#preventing-errors-when-adding-a-tag-video" title="Permalink to this headline">¶</a></h2>
<p>With the current state of our code, attempting to add a tag to an event that already has that tag results in an error. This is because the <code class="docutils literal notranslate"><span class="pre">EventId</span></code>/<code class="docutils literal notranslate"><span class="pre">TagId</span></code> combination is the primary key for our join table, and primary keys must be unique.</p>
<p>Let’s address this scenario.</p>
<div class="admonition-note admonition">
<p class="admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>The starter code for this video is found at the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/display-tags" target="_blank">display-tags branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> of <code class="docutils literal notranslate"><span class="pre">CodingEventsDemo</span></code>. The final code presented in this video is found on the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/tag-errors" target="_blank">tag-errors branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a>. As always, code along to the videos on your own <code class="docutils literal notranslate"><span class="pre">CodingEvents</span></code> project</p>
</div>

<div style="text-align:center;"><iframe width="800" height="450" src="https://www.youtube.com/embed/CWX3juBW4zk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p></p>
</div>
<div class="section" id="preventing-errors-when-adding-a-tag-text">
<h2><span class="section-number">18.5.9. </span>Preventing Errors When Adding a Tag - Text<a class="headerlink" href="#preventing-errors-when-adding-a-tag-text" title="Permalink to this headline">¶</a></h2>
<p>There are multiple ways to address this issue. The approach we take is to allow the user to submit a form with a potentially duplicate <code class="docutils literal notranslate"><span class="pre">EventId</span></code>/<code class="docutils literal notranslate"><span class="pre">TagId</span></code> combination and add a check in the <code class="docutils literal notranslate"><span class="pre">POST</span></code> handler.</p>
<p>Within <code class="docutils literal notranslate"><span class="pre">Controller/TagController.cs</span></code> update the <code class="docutils literal notranslate"><span class="pre">AddEvent</span></code> (<code class="docutils literal notranslate"><span class="pre">POST</span></code> handler) code to look like this:</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="na">[HttpPost]</span>
<span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">AddEvent</span><span class="p">(</span><span class="n">AddEventTagViewModel</span> <span class="n">viewModel</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
   <span class="p">{</span>

         <span class="kt">int</span> <span class="n">eventId</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">EventId</span><span class="p">;</span>
         <span class="kt">int</span> <span class="n">tagId</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">TagId</span><span class="p">;</span>

         <span class="n">List</span><span class="p">&lt;</span><span class="n">EventTag</span><span class="p">&gt;</span> <span class="n">existingItems</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">EventTags</span>
            <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">et</span> <span class="p">=&gt;</span> <span class="n">et</span><span class="p">.</span><span class="n">EventId</span> <span class="p">==</span> <span class="n">eventId</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">et</span> <span class="p">=&gt;</span> <span class="n">et</span><span class="p">.</span><span class="n">TagId</span> <span class="p">==</span> <span class="n">tagId</span><span class="p">)</span>
            <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">existingItems</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
         <span class="p">{</span>
            <span class="n">EventTag</span> <span class="n">eventTag</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EventTag</span> <span class="p">{</span>
               <span class="n">EventId</span> <span class="p">=</span> <span class="n">eventId</span><span class="p">,</span>
               <span class="n">TagId</span> <span class="p">=</span> <span class="n">tagId</span>
            <span class="p">};</span>
            <span class="n">context</span><span class="p">.</span><span class="n">EventTags</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">eventTag</span><span class="p">);</span>
            <span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
         <span class="p">}</span>

         <span class="k">return</span> <span class="nf">Redirect</span><span class="p">(</span><span class="s">&quot;/Events/Detail/&quot;</span> <span class="p">+</span> <span class="n">eventId</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">viewModel</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Lines 68-71 query for existing <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> objects that have the some <code class="docutils literal notranslate"><span class="pre">EventId</span></code>/<code class="docutils literal notranslate"><span class="pre">TagId</span></code> pair. In other words, <code class="docutils literal notranslate"><span class="pre">existingItems</span></code> will be empty unless that given event already has the given tag. Before creating and saving a new <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> object, we check the size of <code class="docutils literal notranslate"><span class="pre">existingItems</span></code>, skipping this step if the event already has the tag.</p>
</div>
<div class="section" id="display-items-with-a-given-tag-video">
<h2><span class="section-number">18.5.10. </span>Display Items With a Given Tag - Video<a class="headerlink" href="#display-items-with-a-given-tag-video" title="Permalink to this headline">¶</a></h2>
<p>In addition to seeing which tags are on an event, we would also like to see all events with a specific tag.</p>
<div class="admonition-note admonition">
<p class="admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>The starter code for this video is found at the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/tag-errors" target="_blank">tag-errors branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> of <code class="docutils literal notranslate"><span class="pre">CodingEventsDemo</span></code>. The final code presented in this video is found on the <a class="reference external" href="https://github.com/LaunchCodeEducation/CodingEventsDemo/tree/display-tag-items" target="_blank">display-tag-items branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a>. As always, code along to the videos on your own <code class="docutils literal notranslate"><span class="pre">CodingEvents</span></code> project</p>
</div>

<div style="text-align:center;"><iframe width="800" height="450" src="https://www.youtube.com/embed/Ajs-tg9nunA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p></p>
</div>
<div class="section" id="display-items-with-a-given-tag-text">
<h2><span class="section-number">18.5.11. </span>Display Items With a Given Tag - Text<a class="headerlink" href="#display-items-with-a-given-tag-text" title="Permalink to this headline">¶</a></h2>
<p>We start by creating a <code class="docutils literal notranslate"><span class="pre">Detail</span></code> action in <code class="docutils literal notranslate"><span class="pre">Controllers/TagController.cs</span></code>. This action method should retrieve all <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> objects with a given <code class="docutils literal notranslate"><span class="pre">TagId</span></code>.</p>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>89
90
91
92
93
94
95
96
97
98</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Detail</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">List</span><span class="p">&lt;</span><span class="n">EventTag</span><span class="p">&gt;</span> <span class="n">eventTags</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">EventTags</span>
         <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">et</span> <span class="p">=&gt;</span> <span class="n">et</span><span class="p">.</span><span class="n">TagId</span> <span class="p">==</span> <span class="n">id</span><span class="p">)</span>
         <span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">et</span> <span class="p">=&gt;</span> <span class="n">et</span><span class="p">.</span><span class="n">Event</span><span class="p">)</span>
         <span class="p">.</span><span class="n">Include</span><span class="p">(</span><span class="n">et</span> <span class="p">=&gt;</span> <span class="n">et</span><span class="p">.</span><span class="n">Tag</span><span class="p">)</span>
         <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>

   <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">eventTags</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Here’s a breakdown of this query:</p>
<ol class="arabic simple">
<li><p><strong>Line 92</strong> - Filters the collection of all <code class="docutils literal notranslate"><span class="pre">EventTag</span></code> objects down to just those with the given <code class="docutils literal notranslate"><span class="pre">TagId</span></code>.</p></li>
<li><p><strong>Line 93</strong> - Eager loads the <code class="docutils literal notranslate"><span class="pre">Event</span></code> child object.</p></li>
<li><p><strong>Line 94</strong> - Eager loads the <code class="docutils literal notranslate"><span class="pre">Tag</span></code> child object.</p></li>
<li><p><strong>Line 95</strong> - Converts the <code class="docutils literal notranslate"><span class="pre">DbSet</span></code> to a list.</p></li>
</ol>
<p>This controller is accessible at the route <code class="docutils literal notranslate"><span class="pre">/Tag/Detail/X</span></code> where <code class="docutils literal notranslate"><span class="pre">X</span></code> is the ID of a specific tag.</p>
<p>The view is similar to other listings that we have created.</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span>@model List<span class="p">&lt;</span><span class="nt">CodingEventsDemo.Models.EventTag</span><span class="p">&gt;</span>

@if (Model.Count == 0)
{
   <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>No elements with the given tag<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
}
else
{
   <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Events Tagged: @Model[0].Tag.Name<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

   <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      @foreach (var evtTag in Model)
      {
         <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>@evtTag.Event.Name<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      }
   <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

}
</pre></div>
</td></tr></table></div>
<p>Finally, we add links to the name of each tag in our tag index.</p>
<p><code class="docutils literal notranslate"><span class="pre">Views/Tag/Index.cshtml</span></code>:</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>@tag.Id<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">asp-controller</span><span class="o">=</span><span class="s">&quot;Tag&quot;</span> <span class="na">asp-action</span><span class="o">=</span><span class="s">&quot;Detail&quot;</span> <span class="na">asp-route-id</span><span class="o">=</span><span class="s">&quot;@tag.Id&quot;</span><span class="p">&gt;</span>@tag.Name<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Start the app up and test user behavior. Viewing the main tag listing should allow you to click on each tag name and view the events that have that tag.</p>
</div>
<div class="section" id="check-your-understanding">
<h2><span class="section-number">18.5.12. </span>Check Your Understanding<a class="headerlink" href="#check-your-understanding" title="Permalink to this headline">¶</a></h2>
<div class="admonition-question admonition">
<p class="admonition-title"><i class="fas fa-question" aria-hidden="true"></i>Question</p>
<p>The use of join tables enables (select all that apply):</p>
<ol class="arabic simple">
<li><p>A database where you never need to run a <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> query.</p></li>
<li><p>Many-to-many relationships between tables.</p></li>
<li><p>Many-to-many relationships between classes without creating a join class.</p></li>
<li><p>Rainbows and butterflies to be stored in your database.</p></li>
</ol>
</div>
<div class="admonition-question admonition">
<p class="admonition-title"><i class="fas fa-question" aria-hidden="true"></i>Question</p>
<p><strong>True/False:</strong> A join table does not have a primary key.</p>
</div>
<div class="admonition-question admonition">
<p class="admonition-title"><i class="fas fa-question" aria-hidden="true"></i>Question</p>
<p>Which <code class="docutils literal notranslate"><span class="pre">EventDbContext</span></code> property allows you to access <code class="docutils literal notranslate"><span class="pre">Tag</span></code> objects that are related to an <code class="docutils literal notranslate"><span class="pre">Event</span></code> object?</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DbSet&lt;Event&gt;</span> <span class="pre">Events</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DbSet&lt;Tag&gt;</span> <span class="pre">Tags</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DbSet&lt;EventTag&gt;</span> <span class="pre">EventTags</span></code></p></li>
<li><p>All of the above</p></li>
</ol>
</div>
</div>
</div>



    
    <nav aria-label="Next and Previous Pages">
      <ul class="pager">
        
        <li class="previous"><a href="some-setup.html"><span aria-hidden="true">&larr;</span> <span class="section-number">18.4. </span>Some Setup</a></li>
        
        
        <li class="next"><a href="exercises.html"><span class="section-number">18.6. </span>Exercises: The Early Bird Gets the ORM. <span aria-hidden="true">&rarr;</span></a></li>
        
      </ul>
    </nav>
    
    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/chapters/orm-relationships/many-to-many.rst.txt"
     rel="nofollow">Page Source</a>
</div>
      
    </p>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>